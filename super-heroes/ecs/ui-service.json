{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "The template used to create an ECS Service from the ECS Console.",
    "Parameters": {
        "CreateIAMRoles": {
            "Type": "String",
            "Default": "False",
            "AllowedValues": [
                "True",
                "False"
            ],
            "Description": "Whether to create default IAM roles",
            "ConstraintDescription": "must specify True or False."
        },
        "ExecutionRoleArn": {
            "Type": "String",
            "Default": "arn:aws:iam::040365544943:role/ecsTaskExecutionRole",
            "Description": "Enter the role arn you want to use as the ecs execution role"
        },
        "ECSClusterName": {
            "Type": "String",
            "Default": "chaos"
        },
        "ECSServiceName": {
            "Type": "String",
            "Default": "quarkus-workshop-ui-service"
        },
        "SecurityGroupIDs": {
            "Type": "CommaDelimitedList",
            "Default": "sg-0ca2fc2bdfa907816"
        },
        "SubnetIDs": {
            "Type": "CommaDelimitedList",
            "Default": "subnet-0ec3f08a1f28407d8,subnet-081ec67fcb58c84d8,subnet-09fa95e81730c8202"
        },
        "VpcID": {
            "Type": "String",
            "Default": "vpc-0aa141fb0f6ddb9aa"
        },
        "LoadBalancerName": {
            "Type": "String",
            "Default": "quarkus-alb"
        }
    },
    "Conditions": {
        "CreateRoles": {
            "Fn::Equals": [
                {
                    "Ref": "CreateIAMRoles"
                },
                "True"
            ]
        },
        "DefaultExecutionRole": {
            "Fn::Equals": [
                {
                    "Ref": "ExecutionRoleArn"
                },
                "Default"
            ]
        }
    },
    "Resources": {
        "ALBSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Security group for Application Load Balancer",
                "VpcId": {
                    "Ref": "VpcID"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "HTTP access from anywhere"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "HTTPS access from anywhere"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "-1",
                        "CidrIp": "0.0.0.0/0",
                        "Description": "All outbound traffic"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "quarkus-alb-sg"
                    }
                ]
            }
        },
        "ApplicationLoadBalancer": {
            "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
            "Properties": {
                "Name": {
                    "Ref": "LoadBalancerName"
                },
                "Scheme": "internet-facing",
                "Type": "application",
                "Subnets": {
                    "Ref": "SubnetIDs"
                },
                "SecurityGroups": [
                    {
                        "Ref": "ALBSecurityGroup"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Ref": "LoadBalancerName"
                        }
                    }
                ]
            }
        },
        "UITargetGroup": {
            "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
            "Properties": {
                "Name": "quarkus-ui-tg",
                "Port": 8080,
                "Protocol": "HTTP",
                "TargetType": "ip",
                "VpcId": {
                    "Ref": "VpcID"
                },
                "HealthCheckPath": "/",
                "HealthCheckProtocol": "HTTP",
                "HealthCheckIntervalSeconds": 30,
                "HealthCheckTimeoutSeconds": 5,
                "HealthyThresholdCount": 2,
                "UnhealthyThresholdCount": 3,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "quarkus-ui-tg"
                    }
                ]
            }
        },
        "FightTargetGroup": {
            "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
            "Properties": {
                "Name": "quarkus-fight-tg",
                "Port": 8080,
                "Protocol": "HTTP",
                "TargetType": "ip",
                "VpcId": {
                    "Ref": "VpcID"
                },
                "HealthCheckPath": "/api/fights",
                "HealthCheckProtocol": "HTTP",
                "HealthCheckIntervalSeconds": 30,
                "HealthCheckTimeoutSeconds": 5,
                "HealthyThresholdCount": 2,
                "UnhealthyThresholdCount": 3,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "quarkus-fight-tg"
                    }
                ]
            }
        },
        "StatsTargetGroup": {
            "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
            "Properties": {
                "Name": "quarkus-stats-tg",
                "Port": 8080,
                "Protocol": "HTTP",
                "TargetType": "ip",
                "VpcId": {
                    "Ref": "VpcID"
                },
                "HealthCheckPath": "/api/stats",
                "HealthCheckProtocol": "HTTP",
                "HealthCheckIntervalSeconds": 30,
                "HealthCheckTimeoutSeconds": 5,
                "HealthyThresholdCount": 2,
                "UnhealthyThresholdCount": 3,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "quarkus-stats-tg"
                    }
                ]
            }
        },
        "ALBListener": {
            "Type": "AWS::ElasticLoadBalancingV2::Listener",
            "Properties": {
                "DefaultActions": [
                    {
                        "Type": "forward",
                        "TargetGroupArn": {
                            "Ref": "UITargetGroup"
                        }
                    }
                ],
                "LoadBalancerArn": {
                    "Ref": "ApplicationLoadBalancer"
                },
                "Port": 80,
                "Protocol": "HTTP"
            }
        },
        "ALBListenerRuleFights": {
            "Type": "AWS::ElasticLoadBalancingV2::ListenerRule",
            "Properties": {
                "Actions": [
                    {
                        "Type": "forward",
                        "TargetGroupArn": {
                            "Ref": "FightTargetGroup"
                        }
                    }
                ],
                "Conditions": [
                    {
                        "Field": "path-pattern",
                        "Values": ["/api/fights*"]
                    }
                ],
                "ListenerArn": {
                    "Ref": "ALBListener"
                },
                "Priority": 1
            }
        },
        "ALBListenerRuleStats": {
            "Type": "AWS::ElasticLoadBalancingV2::ListenerRule",
            "Properties": {
                "Actions": [
                    {
                        "Type": "forward",
                        "TargetGroupArn": {
                            "Ref": "StatsTargetGroup"
                        }
                    }
                ],
                "Conditions": [
                    {
                        "Field": "path-pattern",
                        "Values": ["/api/stats*"]
                    }
                ],
                "ListenerArn": {
                    "Ref": "ALBListener"
                },
                "Priority": 2
            }
        },
        "ECSTaskDefinition": {
            "Type": "AWS::ECS::TaskDefinition",
            "Properties": {
                "Family": "quarkus-workshop-ui",
                "NetworkMode": "awsvpc",
                "RequiresCompatibilities": ["FARGATE"],
                "Cpu": "256",
                "Memory": "512",
                "ExecutionRoleArn": {
                    "Ref": "ExecutionRoleArn"
                },
                "ContainerDefinitions": [
                    {
                        "Name": "quarkus-workshop-ui",
                        "Image": "esara/quarkus-workshop-ui",
                        "Essential": true,
                        "PortMappings": [
                            { "ContainerPort": 8080, "Protocol": "tcp" }
                        ],
                        "Environment": [
                            { "Name": "QUARKUS_HTTP_PORT", "Value": "8080" }
                        ],
                        "LogConfiguration": {
                            "LogDriver": "awslogs",
                            "Options": {
                                "awslogs-group": "/ecs/quarkus-workshop",
                                "awslogs-region": "us-east-2",
                                "awslogs-stream-prefix": "ui"
                            }
                        },
                        "HealthCheck": {
                            "Command": ["CMD-SHELL", "curl -f http://localhost:8080 || exit 1"],
                            "Interval": 30,
                            "Timeout": 5,
                            "Retries": 3,
                            "StartPeriod": 60
                        }
                    }
                ],
                "Tags": [
                    { "Key": "app", "Value": "quarkus-workshop-ui" }
                ]
            }
        },
        "ECSService": {
            "Type": "AWS::ECS::Service",
            "Properties": {
                "Cluster": {
                    "Ref": "ECSClusterName"
                },
                "CapacityProviderStrategy": [
                    {
                        "CapacityProvider": "FARGATE",
                        "Base": 0,
                        "Weight": 1
                    }
                ],
                "TaskDefinition": {
                    "Ref": "ECSTaskDefinition"
                },
                "ServiceName": {
                    "Ref": "ECSServiceName"
                },
                "SchedulingStrategy": "REPLICA",
                "DesiredCount": 1,
                "AvailabilityZoneRebalancing": "ENABLED",
                "NetworkConfiguration": {
                    "AwsvpcConfiguration": {
                        "AssignPublicIp": "ENABLED",
                        "SecurityGroups": {
                            "Ref": "SecurityGroupIDs"
                        },
                        "Subnets": {
                            "Ref": "SubnetIDs"
                        }
                    }
                },
                "PlatformVersion": "LATEST",
                "DeploymentConfiguration": {
                    "DeploymentCircuitBreaker": {
                        "Enable": true,
                        "Rollback": true
                    },
                    "Strategy": "ROLLING",
                    "MaximumPercent": 200,
                    "MinimumHealthyPercent": 100
                },
                "DeploymentController": {
                    "Type": "ECS"
                },
                "LoadBalancers": [
                    {
                        "ContainerName": "quarkus-workshop-ui",
                        "ContainerPort": 8080,
                        "TargetGroupArn": {
                            "Ref": "UITargetGroup"
                        }
                    }
                ],
                "Tags": [],
                "EnableECSManagedTags": true,
                "EnableExecuteCommand": false
            },
            "DependsOn": [
                "ECSTaskDefinition",
                "UITargetGroup",
                "ALBListener"
            ]
        },
        "ECSExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Condition": "CreateRoles",
            "Properties": {
                "Description": "Allows ECS container agent makes calls to the Amazon ECS API on your behalf.",
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ecs-tasks.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy",
                    "arn:aws:iam::aws:policy/CloudWatchLogsFullAccess",
                    "arn:aws:iam::aws:policy/AmazonSSMReadOnlyAccess"
                ],
                "RoleName": "QuarkusExecutionRole"
            }
        }
    },
    "Outputs": {
        "ClusterName": {
            "Description": "The cluster used to create the service.",
            "Value": {
                "Ref": "ECSClusterName"
            }
        },
        "ECSService": {
            "Description": "The created service.",
            "Value": {
                "Ref": "ECSService"
            }
        },
        "LoadBalancerDNS": {
            "Description": "The DNS name of the Application Load Balancer",
            "Value": {
                "Fn::GetAtt": [
                    "ApplicationLoadBalancer",
                    "DNSName"
                ]
            }
        },
        "LoadBalancerURL": {
            "Description": "The URL of the Application Load Balancer",
            "Value": {
                "Fn::Sub": "http://${ApplicationLoadBalancer.DNSName}"
            }
        },
        "FightTargetGroupArn": {
            "Description": "ARN of the Fight Target Group",
            "Value": {
                "Ref": "FightTargetGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-FightTargetGroupArn"
                }
            }
        },
        "StatsTargetGroupArn": {
            "Description": "ARN of the Stats Target Group",
            "Value": {
                "Ref": "StatsTargetGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-StatsTargetGroupArn"
                }
            }
        }
    }
}
